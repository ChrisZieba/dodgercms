/*! dodgercms 0.0.1 2015-05-15 */
$(function(){"use strict";function s3init(force){var accessKeyId=sessionStorage.getItem("dodgercms-token-access-key-id"),secretAccessKey=sessionStorage.getItem("dodgercms-token-secret-access-key"),sessionToken=sessionStorage.getItem("dodgercms-token-session-token");accessKeyId&&secretAccessKey&&sessionToken||dodgercms.auth.redirect(),dodgercms.s3.init(accessKeyId,secretAccessKey,sessionToken,force)}function errorHandler(err){var code=err.code;"ExpiredToken"===code&&($.blockUI(),dodgercms.auth.login(function(err,data){$.unblockUI(),err?dodgercms.auth.redirect():(s3init(!0),rebuildTree())}))}function rebuildTree(){$("#tree").jstree("destroy"),$("#list").empty().html('<div id="tree" class="tree""></div>'),buildTree()}function buildTree(){dodgercms.s3.listObjects(DATA_BUCKET,function(err,data){err?errorHandler(err):dodgercms.s3.headObjects(data.Contents,DATA_BUCKET,function(err,data){var $tree=$("#tree"),tree=[];tree.push({id:"s3--root",parent:"#",text:'<span class="bucket">'+DATA_BUCKET+"</span>",type:"folder",a_attr:{title:DATA_BUCKET},li_attr:{"data-key":"/"},state:{opened:!0}});for(var searchFn=function(e){return e.id===search},i=0;i<data.length;i+=1){var object=data[i],key=object.Key;if("/"===key.substr(-1)||object.ContentType===CONTENT_TYPE)for(var parts=key.replace(/\/\s*$/,"").split("/"),j=0;j<parts.length;j+=1){var isFolder=!1;(j===parts.length-1&&"/"===key.substr(-1)||j!==parts.length-1)&&(isFolder=!0);var search="s3-"+(j>0?parts.slice(0,j+1).join("-"):parts[j]);isFolder&&(search+="-folder");var result=$.grep(tree,searchFn);if(result.length)parts.slice(0,j+1).join("/")===parts.join("/")&&object.Metadata.label&&(result[0].li_attr["data-label"]=object.Metadata.label,result[0].a_attr.title=object.Metadata.label);else{var parent=j>0?"s3-"+parts.slice(0,j).join("-"):"s3--root";"s3--root"!==parent&&(parent+="-folder");var node={id:search,parent:parent,text:parts[j],type:isFolder?"folder":"file",a_attr:{},state:{opened:!0}};isFolder?(node.li_attr={"data-key":j>0?parts.slice(0,j+1).join("/")+"/":parts[j]+"/"},parts.slice(0,j+1).join("/")===parts.join("/")&&object.Metadata.label&&(node.li_attr["data-label"]=object.Metadata.label,node.a_attr.title=object.Metadata.label)):(parts.slice(0,j+1).join("/")===parts.join("/")&&object.Metadata.title&&(node.a_attr.title=object.Metadata.title),"index"===parts[j]&&(node.type="index"),node.li_attr={"data-key":key}),tree.push(node)}}}var onTreeChange=function(event,data){var action=data.action;switch(action){case"select_node":if("folder"!==data.node.type){var key=data.node.li_attr["data-key"];dodgercms.s3.getObject(key,DATA_BUCKET,function(err,data){err?errorHandler(err):(loadKeyContent(key,data),$("#main").data("key",key))})}}},customMenu=function(node){var newFolder=function(elem){for(var input="",key=node.li_attr["data-key"];!/^([a-zA-Z0-9-_]){1,32}$/.test(input);){if(input=window.prompt("Enter the name of the new folder."),null===input)return;input=input.toLowerCase()}if("folder"===node.type){var newKey="/"===key?input+"/":key+input+"/";dodgercms.utils.newFolder(newKey,DATA_BUCKET,SITE_BUCKET,function(err,data){addNode(newKey,key,input)})}},renameItem=function(elem){var msg,key=node.li_attr["data-key"],parts=key.replace(/\/\s*$/,"").split("/"),last=parts[parts.length-1],input=last;do{if(msg="folder"===node.type?"Enter the new name for folder: "+input:"Enter the new name for entry: "+input,input=window.prompt(msg,input),null===input)return;input=input.toLowerCase()}while(!/^([a-zA-Z0-9-_]){1,32}$/.test(input));if(input!==last){block();var target=input;"folder"!==node.type&&(parts.splice(-1,1,input),target=parts.join("/")),dodgercms.entry.rename(key,target,DATA_BUCKET,SITE_BUCKET,function(err,data){unblock(),err?errorHandler(err):dodgercms.entry.menu(SITE_BUCKET,SITE_ENDPOINT,function(err){err?errorHandler(err):(rebuildTree(),$("#main").data("key",key))})})}},editLabel=function(elem){var input,msg,label=node.li_attr["data-label"],key=node.li_attr["data-key"];do if(msg=label?"Enter the name of the new label for the directory: "+key:"Enter the label (used for the frontend menu) for the directory: "+key,input=label?window.prompt(msg,label):window.prompt(msg),null===input)return;while(!/^([\w-_\.\s\(\)\/\\]){1,32}$/.test(input));if(input!==label){var params={Bucket:DATA_BUCKET,Key:key,Metadata:{label:input}};dodgercms.s3.putObject(params,function(err,data){err?errorHandler(err):(params.Bucket=SITE_BUCKET,dodgercms.s3.putObject(params,function(err,data){err&&errorHandler(err)}))})}},editItem=function(elem){var key=node.li_attr["data-key"];editEntry(key)},removeItem=function(elem){var key=node.li_attr["data-key"],input=window.confirm("Are you sure?");null!==input&&dodgercms.entry.remove(key,DATA_BUCKET,SITE_BUCKET,function(err,data){err?errorHandler(err):dodgercms.entry.menu(SITE_BUCKET,SITE_ENDPOINT,function(err){clearEntry(key),$tree.jstree("delete_node","#"+node.id)})})},newItem=function(elem){var key=node.li_attr["data-key"];"folder"===node.type&&newEntry(key)},items={editLabel:{},newEntry:{label:"New Entry",action:newItem},editEntry:{label:"Edit",action:editItem},newFolder:{label:"New Folder",separator_after:!0,action:newFolder},renameItem:{label:"Rename",action:renameItem},removeItem:{label:"Delete",action:removeItem}};if("folder"===node.type){var label=node.li_attr["data-label"],labelText=label?"Edit Label":"Add Label";items.editLabel={label:labelText,separator_after:!0,action:editLabel},delete items.editEntry}else items.newEntry._disabled=!0,items.newFolder._disabled=!0,delete items.editLabel;return"s3--root"===node.id&&(items.removeItem._disabled=!0,items.renameItem._disabled=!0,items.editLabel._disabled=!0),items};$tree.on("changed.jstree",onTreeChange).jstree({core:{check_callback:!0,themes:{dots:!0,name:"proton",responsive:!1},animation:!1,data:tree},types:{"default":{icon:"fa"},file:{icon:"fa fa-file-text-o"},index:{icon:"fa fa-asterisk"},folder:{icon:"fa fa-folder-o",select_node:!1}},plugins:["unique","contextmenu","sort","ui","types"],contextmenu:{items:customMenu,select_node:!1},sort:function(a,b){var nodeA=this.get_node(a),nodeB=this.get_node(b);return nodeA.type===nodeB.type?this.get_text(a)>this.get_text(b)?1:-1:"index"===nodeA.type?-1:"index"===nodeB.type?1:"file"===nodeA.type?1:-1}})})})}function doesTreeNodeExist(id){return $("#tree").jstree("get_node",id)?!0:!1}function addNode(key,parent,text,title){var folder=dodgercms.utils.isFolder(key),id=getTreeNodeId(key);parent=getTreeNodeId(parent);var node={id:id,parent:parent,text:text,type:folder?"folder":"file",li_attr:{"data-key":key},state:{opened:!0}};return"index"===text&&(node.type=text),title&&(node.a_attr={title:title}),doesTreeNodeExist(id)||$("#tree").jstree("create_node","#"+parent,node),node}function block(){$.blockUI({css:{border:"none",padding:"15px",backgroundColor:"#000","-webkit-border-radius":"10px","-moz-border-radius":"10px",opacity:.5,color:"#fff"},overlayCSS:{backgroundColor:"#000",opacity:0,cursor:"wait"}})}function unblock(){$.unblockUI()}function save(event){event.preventDefault();var $title=$("#entry-form-title"),$folder=$("#entry-form-folder"),$slug=$("#entry-form-slug"),$content=$("#entry-form-content"),title=$.trim($title.val()),folder=$("option:selected",$folder).data("folder"),slug=$.trim($slug.val()).toLowerCase(),content=$.trim($content.val());if(!title.length||title.length>64)return void alert("The title needs to be between 1 and 64 characters.");if(!/^([a-zA-Z0-9-_]){1,32}$/.test(slug))return void alert("The url slug must be at most 32 characters, and can only contain letters, numbers, dashes, underscores.");block();var callback=function(key,folder,slug,title){$("#main").data("key",key),addNode(key,folder,slug,title),$slug.attr("data-entry-form-slug",slug),$slug.data("entry-form-slug",slug),$slug.val(slug),$folder.attr("data-entry-form-folder",folder),$folder.data("entry-form-folder",folder),dodgercms.entry.upsert(key,title,content,SITE_BUCKET,SITE_ENDPOINT,function(err,data){err?errorHandler(err):dodgercms.entry.menu(SITE_BUCKET,SITE_ENDPOINT,function(){unblock()})})},key="/"!==folder?folder+slug:slug,$folderData=$folder.data("entry-form-folder"),$slugData=$slug.data("entry-form-slug");if($slugData&&$folderData&&($folderData!==folder||$slugData!==slug)){var oldKey="/"!==$folderData?$folderData+$slugData:$slugData;dodgercms.entry.rename(oldKey,key,DATA_BUCKET,SITE_BUCKET,function(err,data){err?errorHandler(err):($("#tree").jstree("delete_node","#"+getTreeNodeId(oldKey)),callback(key,folder,slug,title))})}else{var params={Bucket:DATA_BUCKET,Key:key,Body:content,ContentEncoding:"utf-8",ContentType:CONTENT_TYPE,Expires:0,CacheControl:"public, max-age=0, no-cache",Metadata:{title:title}};dodgercms.s3.putObject(params,function(err,data){callback(key,folder,slug,title)})}}function editEntry(key){dodgercms.s3.getObject(key,DATA_BUCKET,function(err,data){var body=data.Body.toString(),source=$("#edit-entry-template").html(),template=Handlebars.compile(source),modified=new Date(data.LastModified);dodgercms.s3.listObjects(DATA_BUCKET,function(err,list){if(err)errorHandler(err);else{var folders=dodgercms.utils.getFolders(list.Contents),slug=dodgercms.utils.getSlug(key),selectedFolder=key.indexOf("/")>-1?key.substr(0,key.lastIndexOf("/")+1):"/",context={title:data.Metadata.title,modified:modified.toLocaleString(),key:key,folders:folders,selectedFolder:selectedFolder,slug:slug,content:body},html=template(context);$("#main").html(html)}})})}function clearEntry(key){key===$("#main").data("key")&&$("#main").empty().data("key",null)}function getTreeNodeId(key){if("/"===key)return"s3--root";var id,parts=key.replace(/\/\s*$/,"").split("/"),prefix="s3-",folderSuffix="-folder";return id=dodgercms.utils.isFolder(key)?prefix+parts.join("-")+folderSuffix:prefix+parts.join("-")}function newEntry(folder){dodgercms.s3.listObjects(DATA_BUCKET,function(err,data){if(err)errorHandler(err);else{var folders=dodgercms.utils.getFolders(data.Contents),context={folders:folders,selectedFolder:folder?folder:null},source=$("#edit-entry-template").html(),template=Handlebars.compile(source),html=template(context);$("#main").html(html)}})}function loadKeyContent(key,content){var body=content.Body.toString(),source=$("#entry-template").html(),template=Handlebars.compile(source),modified=new Date(content.LastModified),context={title:content.Metadata.title,modified:modified.toLocaleString(),link:"",key:key,content:marked(body,markedOptions)},html=template(context);$("#main").html(html).data("key",key),$("#main .content-body pre code").each(function(i,block){hljs.highlightBlock(block)})}var DATA_BUCKET=localStorage.getItem("dodgercms-data-bucket"),ASSETS_BUCKET=localStorage.getItem("dodgercms-assets-bucket"),SITE_BUCKET=localStorage.getItem("dodgercms-site-bucket"),SITE_ENDPOINT=localStorage.getItem("dodgercms-site-endpoint"),CONTENT_TYPE="text/plain; charset=UTF-8",S3_ENDPOINT="s3.amazonaws.com",markedOptions={renderer:new marked.Renderer,gfm:!0,tables:!0,breaks:!1,pedantic:!1,sanitize:!0,smartLists:!0,smartypants:!1,highlight:function(code){return hljs.highlightAuto(code).value}};Handlebars.registerHelper("selected",function(option,value){return option===value?' selected="selected"':""}),Handlebars.registerHelper("raw-helper",function(options){return options.fn()}),s3init(!1),buildTree(),$(document).on("click","#delete-entry",function(event){var key=$(this).data("key");"undefined"!=typeof key&&window.confirm("Are you sure?")&&dodgercms.entry.remove(key,DATA_BUCKET,SITE_BUCKET,function(err,data){err?errorHandler(err):dodgercms.entry.menu(SITE_BUCKET,SITE_ENDPOINT,function(){$("#tree").jstree("delete_node","#"+getTreeNodeId(key)),clearEntry(key)})})}),$(document).on("click","#close-entry",function(event){var key=$("#main").data("key");key&&"/"!==key?dodgercms.s3.getObject(key,DATA_BUCKET,function(err,data){err?errorHandler(err):loadKeyContent(key,data)}):clearEntry(key)}),$(document).on("submit","#entry-form",save),$(document).on("click","#edit-entry",function(event){var key=$(this).data("key");"undefined"!=typeof key&&editEntry(key)}),$(document).on("click","#preview-entry",function(event){var preview=$("#content-preview"),content=$("#entry-form-content");if(preview.length>0)preview.remove(),content.show(),$(this).html('<i class="fa fa-search"></i>'),$(this).prop("title","Preview"),$("label[for=upload-image]").removeClass("none");else{var md=content.val(),html='<div id="content-preview">'+marked(md,markedOptions)+"</div>";content.hide(),$("#content-body-container").append(html),$("#content-preview pre code").each(function(i,block){hljs.highlightBlock(block)}),$(this).html('<i class="fa fa-pencil"></i>'),$(this).prop("title","Write"),$("label[for=upload-image]").addClass("none")}}),$(document).on("change","#upload-image",function(event){var file=$("#upload-image")[0].files[0],content=$("#entry-form-content"),types=["image/png","image/jpg","image/jpeg","image/gif"];if(!file||types.indexOf(file.type)<0)return void alert("Only images can be uploaded.");if(!(content.length<=0)&&content.is(":visible")){var filename="images/"+file.name.replace(/\s|\\|\/|\(|\)/g,"-"),link="http://"+ASSETS_BUCKET+"."+S3_ENDPOINT+"/"+filename,params={Bucket:ASSETS_BUCKET,Key:filename,ContentType:file.type,Body:file};dodgercms.s3.upload(params,function(err,data){if(err)errorHandler(err);else{var cursorPosStart=content.prop("selectionStart"),cursorPosEnd=content.prop("selectionEnd"),v=content.val(),textBefore=v.substring(0,cursorPosStart),textAfter=v.substring(cursorPosEnd,v.length);content.val(textBefore+"!["+file.name+"]("+link+")"+textAfter)}})}}),$("#new-entry").click(function(event){newEntry(null)}),$(document).on("click",".pure-button",function(){$(this).blur()}),$(document).bind("keydown",function(event){event.ctrlKey&&83===event.which&&$("#entry-form").is(":visible")&&save(event)})});